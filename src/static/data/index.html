<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <title>Sybeol Home monitoring</title>
    <meta name="description" content="Power metering for smart homes" />
    <meta name="keywords" content="energy, power, metering, home, ecology, savings" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <!-- stylesheets -->
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen" />

    <!-- jQuery - the core -->
    <script src="/js/jquery-1.6.2.min.js" type="text/javascript"></script>
    <script src="/js/jquery.tmpl.min.js" type="text/javascript"></script>

    <!-- charts API -->
    <script src="/js/highcharts.js" type="text/javascript"></script>
    <script src="/js/chart.js" type="text/javascript"></script>

    <script src="/js/login.js" type="text/javascript"></script>
    <script src="/js/sybeol.js" type="text/javascript"></script>

    <script type="text/javascript">

        var deviceSelectedTemplate = "<button class=\"menuButton menuButtonSelected\" onclick=\"setSelectedDevice('${name}')\">${name}</button>";
        var deviceTemplate = "<button class=\"menuButton\" onclick=\"setSelectedDevice('${name}')\">${name}</button>";

        $.template("deviceSelectedTemplate", deviceSelectedTemplate);
        $.template("deviceTemplate", deviceTemplate);

        var chartData;


        var showGraph = function(activeDevice) {
            if(!activeDevice) {
                showNoData();
            } else {
                Sybeol.getMeasures(activeDevice.name, function(data) {
                    if(data && data.length > 0) {

                        var serie = new Object();
                        serie.name = activeDevice.name;
                        serie.data = new Array();
                        for(var i = 0 ; i < data.length ; i++) {
                            serie.data[i] = new Array();
                            serie.data[i][0] = Date.parse(data[i].time);
                            serie.data[i][1] = data[i].value;
                        }

                        chartData = serie;
                        initChart('chartContainer', [chartData], activeDevice);
                    } else {
                        showNoData();
                    }
                });
            }
        }

        var hideGraph = function() {
            $('#chartContainer').hide();
        }


        var setSelectedDevice = function(deviceName) {
            refreshDevices(deviceName, showGraph);
        }


        var refreshDevices = function(deviceName, cb) {
            $("#devicesMenu").html("");
            Sybeol.getDevices(function(sensors) {
                var device;
                if(sensors && sensors.length > 0) {
                    if(!deviceName) {
                        device = sensors[0];
                        deviceName = sensors[0].name;
                    }
                    for(var i=0 ; i <sensors.length ; i++) {
                        if(deviceName == sensors[i].name) {
                            device = sensors[i];
                            $.tmpl("deviceSelectedTemplate", sensors[i]).appendTo("#devicesMenu");
                        } else {
                            $.tmpl("deviceTemplate", sensors[i]).appendTo("#devicesMenu");
                        }
                    }
                } else {
                    //TODO: show message to add sensors
                }
                cb(device);
            });
        }

        var showNoData = function() {
            $("#chartContainer").html('You don\'t have any data yet<br/> Do you want to <a href="/devices/">add a new device</a> ?');
        }

        $(document).ready(function() {

            autoRedirectToLogin();


            $('#header').load('/elements/menu.html');
            $('#footer').load('/elements/footer.html');


            refreshDevices(null, showGraph);

            $(".menuButton").click(function(event) {
                alert(JSON.stringify(event));
            });

            $(".tab_content").hide(); //Hide all content
            $("ul.tabs li:first").addClass("active").show(); //Activate first tab
            $(".tab_content:first").show(); //Show first tab content

            //On Click Event
            $("ul.tabs li").click(function() {

                $("ul.tabs li").removeClass("active"); //Remove any "active" class
                $(this).addClass("active"); //Add "active" class to selected tab
                $(".tab_content").hide(); //Hide all tab content

                var activeTab = $(this).find("a").attr("href"); //Find the href attribute value to identify the active tab + content
                $(activeTab).fadeIn(); //Fade in the active ID content
                return false;
            });
        });

    </script>
</head>

<body>
<div id="header" class="header">

</div>
<div class="headerContentLeft">
    <a href="/">
        <img width="50px" class="inline" src="/css/images/logo_Sybeol_small.png" alt="Logo Sybeol"/>
        <h1 class="inline">Sybeol</h1>
    </a>
</div>
<div class="content">
    <div id="devicesMenu" class="leftMenu">
    </div>
    <div class="eighthundred">
        <h2>Home</h2>
        <hr/>
        <br/>
        <ul class="tabs">
            <li><a href="#tab1">Daily</a></li>
            <li><a href="#tab2">Weekly</a></li>
            <li><a href="#tab3">Yearly</a></li>
        </ul>
        <br/>
        <br/>

        <div class="tab_container">
            <div id="tab1" class="tab_content">
                <div id="chartContainer" class="chartContainer" ></div>
            </div>
            <div id="tab2" class="tab_content">
                <!--Content-->
            </div>
            <div id="tab3" class="tab_content">
                <!--Content-->
            </div>
        </div>

    </div>

</div>

<div id="footer"></div>
</body>
</html>
<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26203167-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>
